<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sauda Mart</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include Font Awesome for the dustbin icon -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* Custom styles for badges */
        .table-responsive {
            position: relative;
            overflow: auto;
            height: 400px; /* Adjust height as needed */
        }

        .table thead th {
            position: sticky;
            top: 0;
            z-index: 10; /* Ensures the header is above the other content */
            background-color: #343a40; /* Match this with your table header background */
            color: white; /* Change text color if needed */
        }
        .qty-badge {
            background-color: #007bff;
            color: white;
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-left: 5px;
        }
        h1 {
            font-size: 2rem;
        }
        .btn-custom {
            margin-right: 10px;
        }
        /* Responsive table adjustments */
        .table-responsive {
            overflow-x: auto;
        }
        /* Flexbox for mobile inputs */
        @media (max-width: 576px) {
            .input-group-mobile {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>

    <div class="container mt-4">
        <div class="text-center">
            <h1>Sauda Mart</h1>
            
        </div>
        <p>Order Date: <span id="current-date"></span> &nbsp; | &nbsp; Delivery Date: 
            <input type="date" id="delivery-date" class="form-control d-inline-block" style="width: auto;" required>
        </p>
        

    
        <!-- Shop Section with Add Shop Button -->
        <div class="row mb-3 sticky-top bg-white">
            <div class="col-md-6">
                <label for="shop-name" class="form-label">Select Shop:</label>
                <select class="form-select" id="shop-name" onchange="updatePreviousBalance()">
                    <option value="MEHRAN BAKERY NO.2">MEHRAN BAKERY NO.2</option>
                    <option value="AHMED MINI MART NO.2">AHMED MINI MART NO.2</option>
                    <option value="FAMY CLIFTON">FAMY CLIFTON</option>
                    <option value="FAZL-E-RABBI">FAZL-E-RABBI</option>
                    <option value="SINDH PARADISE">SINDH PARADISE</option>
                    <option value="AL-REHMAN BILAWAL HOUSE">AL-REHMAN BILAWAL HOUSE</option>
                    <option value="DANISH DISCOUNT">DANISH DISCOUNT</option>
                    <option value="ANUSHA GULSHAN">ANUSHA GULSHAN</option>
                    <option value="KAUSAR KORANGI">KAUSAR KORANGI</option>
                    <option value="BIS CGHS">BIS CGHS</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="payment-mode" class="form-label">Payment Mode:</label>
                <select class="form-select" id="payment-mode" onchange="handlePaymentChange()">
                    <option value="cash">Cash</option>
                    <option value="credit">Credit</option>
                </select>
            </div>
        </div>
    
        <!-- Credit Options (Hidden by Default) -->
        <div id="credit-options" class="row mb-3" style="display: none;">
            <div class="col-md-6">
                <label for="credit-type" class="form-label">Select Credit Type:</label>
                <select class="form-select" id="credit-type">
                    <option value="bill-sign">Bill Sign</option>
                    <option value="cheque">Cheque</option>
                </select>
            </div>
            <div class="col-md-6">
                <p id="previousBalanceDisplay" class="mt-4"></p>
            </div>
        </div>

        <div class="mb-3 text-end">
            <button class="btn btn-info btn-custom" onclick="previewTable()" title="Preview">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-success btn-custom" onclick="sendWhatsApp()" title="Send via WhatsApp">
                <i class="fab fa-whatsapp"></i>
            </button>
            <button class="btn btn-danger" onclick="generatePDF()" title="Generate PDF">
                <i class="fas fa-file-pdf"></i>
            </button>
            <button id="loadDataBtn" class="btn btn-secondary">Create Order</button>
        </div>
    
        <!-- Search and Add Quantity Section -->
        <div class="row mb-3 sticky-top bg-white">
            <div class="col-md-6 col-sm-6 mb-0 mb-md-0">
                <input type="text" id="searchBar" class="form-control" onkeyup="searchTable()" placeholder="Search for products...">
            </div>
            <div class="col-md-6 col-sm-6 d-flex align-items-center">
                <input type="number" id="qtyInput" class="form-control me-2" placeholder="Enter Qty" min="1" inputmode="numeric">
                <button id="addQtyBtn" class="btn btn-primary" onclick="applyQuantity()">Add</button>
            </div>
        </div>
    
        
    </div>
    
    <!-- Responsive Product Table -->
    <div class="table-responsive">
        <table id="productTable" class="table table-bordered table-hover">
            <thead class="table-dark">
                <tr>
                    <th>Product ID</th>
                    <th>Product Name</th>
                    <th>Retail Price</th>
                    <th>Offer Price</th>
                </tr>
            </thead>
                <tbody>
                    <!-- Data will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- User Info -->
        <!-- <div class="mb-3">
            <label for="userName" class="form-label">Enter Your Name:</label>
            <input type="text" id="userName" class="form-control" required>
        </div> -->

        <!-- Button Group -->
        <!-- <div class="button-group text-end">
            <button class="btn btn-info btn-custom" onclick="previewTable()">Preview</button>
            <button class="btn btn-success btn-custom" onclick="sendWhatsApp()">Send WhatsApp</button>
            <button class="btn btn-danger" onclick="generatePDF()">Generate PDF</button>
        </div> -->
    </div>

    <!-- Bootstrap JS and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>

    <script>
        document.getElementById('current-date').textContent = new Date().toLocaleDateString();

        function handlePaymentChange() {
            const paymentMode = document.getElementById('payment-mode').value;
            const creditOptions = document.getElementById('credit-options');
            creditOptions.style.display = paymentMode === 'credit' ? 'block' : 'none';
        }

        function updatePreviousBalance() {
            const shopName = document.getElementById('shop-name').value.trim();
            fetch('BALANCE.json')
                .then(response => response.json())
                .then(data => {
                    const previousBalance = data[shopName]?.previousBalance;
                    document.getElementById('previousBalanceDisplay').innerHTML = `Previous Balance: Rs.${previousBalance !== undefined ? previousBalance : 0}`;
                })
                .catch(error => console.error('Error loading balance data:', error));
        }

        document.getElementById('shop-name').addEventListener('change', updatePreviousBalance);
        window.onload = function() {
            updatePreviousBalance();
        };

        function searchTable() {
            let input = document.getElementById('searchBar').value.toUpperCase();
            let table = document.getElementById('productTable');
            let tr = table.getElementsByTagName('tr');

            for (let i = 1; i < tr.length; i++) {
                let td = tr[i].getElementsByTagName('td')[1];
                if (td) {
                    let txtValue = td.textContent || td.innerText;
                    tr[i].style.display = txtValue.toUpperCase().indexOf(input) > -1 ? '' : 'none';
                }
            }
        }

        let updatedProducts = [];
        let selectedRowIndex = null;

        document.getElementById('loadDataBtn').addEventListener('click', function() {
            fetch('PRODUCTS.json')
                .then(response => response.json())
                .then(data => {
                    const tableBody = document.querySelector('#productTable tbody');
                    tableBody.innerHTML = '';
                    updatedProducts = data;

                    data.forEach((product, index) => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${product.ProductID}</td>
                            <td>${product.ProductName}</td>
                            <td>${product.RetailPrice}</td>
                            <td contenteditable="true" onblur="updateOfferPrice(this, ${index})">${product.OfferPrice}</td>
                        `;

                        row.addEventListener('click', function() {
                            const rows = document.querySelectorAll('#productTable tbody tr');
                            rows.forEach(row => row.classList.remove('table-active'));
                            row.classList.add('table-active');
                            selectedRowIndex = index;
                        });

                        tableBody.appendChild(row);
                    });
                })
                .catch(error => console.error('Error loading data:', error));
        });

        function applyQuantity() {
    const qtyInput = document.getElementById('qtyInput');
    const qtyValue = parseInt(qtyInput.value);

    if (selectedRowIndex === null) {
        alert('Please select a product row first.');
        return;
    }

    if (isNaN(qtyValue) || qtyValue <= 0) {
        alert('Please enter a valid quantity.');
        return;
    }

    const row = document.querySelector(`#productTable tbody tr:nth-child(${selectedRowIndex + 1})`);
    
    // Set the quantity directly to the new value
    row.setAttribute('data-qty', qtyValue);

    // Store quantity in data attribute
    // let currentQty = parseInt(row.getAttribute('data-qty')) || 0;
    // let newQty = currentQty + qtyValue;
    // row.setAttribute('data-qty', newQty);

    // Update the product name with a badge and dustbin icon
    const productNameCell = row.cells[1];
    let qtyBadge = productNameCell.querySelector('.qty-badge');
    let dustbinIcon = productNameCell.querySelector('.qty-dustbin');

    // Update or create the quantity badge
    if (qtyBadge) {
        qtyBadge.textContent = qtyValue; // Update existing badge
    } else {
        qtyBadge = document.createElement('span');
        qtyBadge.className = 'qty-badge';
        qtyBadge.textContent = qtyValue;

        // Create the dustbin icon
        dustbinIcon = document.createElement('i');
        dustbinIcon.className = 'fas fa-trash-alt qty-dustbin';
        dustbinIcon.style.color = 'red';
        dustbinIcon.style.cursor = 'pointer';
        
        // Add click event to the dustbin icon
        dustbinIcon.onclick = function() {
            // Reset quantity
            row.setAttribute('data-qty', 0);
            qtyBadge.remove();
            dustbinIcon.remove();
        
        };
        productNameCell.appendChild(qtyBadge);
        productNameCell.appendChild(dustbinIcon);
    }

    qtyInput.value = '';
}


       // Function to handle preview
       function previewTable() {
    let table = document.getElementById('productTable');
    let tr = table.getElementsByTagName('tr');
    let previewWindow = window.open('', '', 'width=800,height=600');

    let shopName = document.getElementById('shop-name').value;
    let paymentMode = document.getElementById('payment-mode').value;
    let creditType = paymentMode === 'credit' ? document.getElementById('credit-type').value : 'N/A';
    let previousBalance = document.getElementById('previousBalanceDisplay').textContent;
    let currentDate = new Date().toLocaleDateString();

    previewWindow.document.write(`<h2>${currentDate} - ${shopName} - ${paymentMode} - ${creditType} - Previous Balance: Rs.${previousBalance}</h2>`);
    previewWindow.document.write('<table border="1" cellpadding="5" cellspacing="0">');
    previewWindow.document.write('<tr><th>Product ID</th><th>Product Name</th><th>Quantity</th><th>Retail Price</th><th>Offer Price</th><th>Total Amount</th></tr>');

    let grandTotal = 0;

    for (let i = 1; i < tr.length; i++) {
        let row = tr[i];
        let qtyValue = parseInt(row.getAttribute('data-qty')) || 0;  // Fetch quantity from data attribute

        if (qtyValue > 0) {
            let productId = row.cells[0].textContent;
            let productName = row.cells[1].childNodes[0].textContent.trim();  // Extract product name
            let retailPrice = parseFloat(row.cells[2].textContent) || 0;
            let offerPrice = parseFloat(row.cells[3].textContent) || 0;
            let totalAmount = qtyValue * offerPrice;
            grandTotal += totalAmount;

            previewWindow.document.write(`<tr>
                <td>${productId}</td>
                <td>${productName}</td>
                <td>${qtyValue}</td>
                <td>Rs. ${retailPrice.toFixed(2)}</td>
                <td>Rs. ${offerPrice.toFixed(2)}</td>
                <td>Rs. ${totalAmount.toFixed(2)}</td>
            </tr>`);
        }
    }

    previewWindow.document.write(`<tr><td colspan="5" style="text-align: right;">Grand Total</td><td>Rs. ${grandTotal.toFixed(0)}</td></tr>`);
    previewWindow.document.write('</table>');
    previewWindow.document.close();
}






// Function to handle WhatsApp message
function sendWhatsApp() {
    let shopName = document.getElementById('shop-name').value;
    let paymentMode = document.getElementById('payment-mode').value;
    let creditType = paymentMode === 'credit' ? document.getElementById('credit-type').value : 'N/A';
    let previousBalance = document.getElementById('previousBalanceDisplay').textContent;
    let table = document.getElementById('productTable');
    let tr = table.getElementsByTagName('tr');

    let message = `Order Details\nShop: ${shopName}\nPayment: ${paymentMode} - ${creditType}\nPrevious Balance: ${previousBalance}\n\nProducts:\n`;

    let grandTotal = 0;

    for (let i = 1; i < tr.length; i++) {
        let row = tr[i];
        let qtyValue = parseInt(row.getAttribute('data-qty')) || 0;

        if (qtyValue > 0) {
            let productName = row.cells[1].childNodes[0].textContent.trim();  // Extract product name
            let offerPrice = parseFloat(row.cells[3].textContent) || 0;
            let totalAmount = qtyValue * offerPrice;
            grandTotal += totalAmount;

            message += `${productName} - Qty: ${qtyValue}, Total: Rs.${totalAmount.toFixed(2)}\n`;
        }
    }

    message += `\nGrand Total: Rs.${grandTotal.toFixed(0)}`;

    let whatsappUrl = `https://api.whatsapp.com/send?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}





// Function to generate PDF
function generatePDF() {
    const { jsPDF } = window.jspdf;
    let doc = new jsPDF();

    let shopName = document.getElementById('shop-name').value;
    let paymentMode = document.getElementById('payment-mode').value;
    let creditType = paymentMode === 'credit' ? document.getElementById('credit-type').value : 'N/A';
    let previousBalance = document.getElementById('previousBalanceDisplay').textContent;
    let currentDate = new Date().toLocaleDateString();

    let fileName = `${currentDate} - ${shopName}.pdf`;

    doc.setFontSize(12);
    doc.text(`Sauda Mart`, 90, 10);
    doc.text(`Date: ${currentDate}`, 10, 20);
    doc.text(`Shop: ${shopName}`, 10, 30);
    doc.text(`Payment mode and type: ${paymentMode} and ${creditType}`, 10, 40);
    doc.text(`Previous Balance: ${previousBalance}`, 10, 50);

    let tableData = [];
    let grandTotal = 0;
    let table = document.getElementById('productTable');
    let tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        let row = tr[i];
        let qtyValue = parseInt(row.getAttribute('data-qty')) || 0;

        if (qtyValue > 0) {
            let productName = row.cells[1].childNodes[0].textContent.trim();
            let retailPrice = parseFloat(row.cells[2].textContent) || 0;
            let offerPrice = parseFloat(row.cells[3].textContent) || 0;
            let totalAmount = qtyValue * offerPrice;
            grandTotal += totalAmount;

            tableData.push([
                row.cells[0].textContent,      // Product ID
                productName,                   // Product Name
                qtyValue,                      // Quantity
                retailPrice.toFixed(2),         // Retail Price
                offerPrice.toFixed(2),          // Offer Price
                totalAmount.toFixed(2)          // Total Amount
            ]);
        }
    }

    doc.autoTable({
        startY: 60,
        head: [['Product ID', 'Product Name', 'Quantity', 'Retail Price', 'Offer Price', 'Total Amount']],
        body: tableData,
        columnStyles: {
            2: { halign: 'right' },  // Order Quantity column
            3: { halign: 'right' },  // Retail Price column
            4: { halign: 'right' },  // Offer Price column
            5: { halign: 'right' }   // Total Amount column
        }

    });

    doc.text(`Grand Total: Rs.${grandTotal.toFixed(0)}`, 152.5, doc.lastAutoTable.finalY + 10);

    doc.save(fileName);
}


    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.20/jspdf.plugin.autotable.min.js"></script>
    
</body>
</html>
